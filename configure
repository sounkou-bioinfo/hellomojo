#!/bin/sh
thisDir=$(dirname "$0")
thisDir=`realpath $thisDir`

# Default: skip Mojo build unless HELLOMOJO_BUILD is explicitly set
if [ -z "${HELLOMOJO_BUILD}" ]; then
    echo "HELLOMOJO_BUILD not set - skipping Mojo build (set HELLOMOJO_BUILD=1 to enable)" >&2
    # Generate Makevars without Mojo
    sed -e 's|@MOJO_CFLAGS@|-DHELLOMOJO_NO_BUILD|' \
        -e 's|@MOJO_LIBS@||' \
        ${thisDir}/src/Makevars.in > ${thisDir}/src/Makevars
    exit 0
fi

echo "HELLOMOJO_BUILD is set - building Mojo shared library" >&2

# install mojo and pixi if necessary
pixi="${HOME}/.pixi/bin/pixi"
command -v $pixi >/dev/null 2>&1 || { 
    echo "pixi not found, installing pixi..." >&2; 
    curl -fsSL https://pixi.sh/install.sh | sh
}
if [ ! -f "$pixi" ]; then
    echo "pixi installation failed!" >&2
    exit 1
fi
cd ${thisDir}/inst/mojo || mkdir -p ${thisDir}/inst/mojo
cd ${thisDir}/inst/mojo/hellomojo || exit 1
if [ ! -d "${thisDir}/inst/libs" ]; then
    mkdir -p "${thisDir}/inst/libs"
fi
$pixi add mojo || true
$pixi run mojo --version
# build share library with the right suffix for the platform
if [ "$(uname)" = "Darwin" ]; then
   libsuffix="dylib"
elif [ "$(expr substr $(uname -s) 1 5)" = "Linux" ]; then
   libsuffix="so"
else 
   libsuffix="dll"
fi
$pixi run mojo build hellomojo.mojo \
--emit shared-lib \
-o ${thisDir}/inst/libs/libhello.${libsuffix} || exit 1

ls ${thisDir}/inst/libs/libhello.${libsuffix} || exit 1

# Generate Makevars with Mojo
sed -e 's|@MOJO_CFLAGS@||' \
    -e "s|@MOJO_LIBS@|-L\$(ThisDIR)/../inst/libs -lhello -Wl,-rpath,'\$\$ORIGIN'|" \
    ${thisDir}/src/Makevars.in > ${thisDir}/src/Makevars